<html>
    <head>
        <title>Tensorflow.js linear regression</title>
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"> </script>
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis"></script>
    </head>
    <body>
        <script type="text/javascript">
            async function plot(pointsArray, featureName) {
                tfvis.render.scatterplot(
                    { name: `${featureName} vs House Price` },
                    { values: [pointsArray], series: ["original"]},
                    {
                        xLabel: featureName,
                        yLabel: "Price",
                    }
                )
            }

            function normalise(tensor){
                const min = tensor.min()
                const max = tensor.max()
                const normalisedTensor = tensor.sub(min).div(max.sub(min));
                return {
                    tensor: normalisedTensor,
                    min,
                    max
                }
            }

            function denormalise(tensor, min, max){
                const denormalisedTensor = tensor.mul(max.sub(min)).add(min);
                return denormalisedTensor
            }

            function createModel() {
                const model = tf.sequential();

                model.add(tf.layers.dense({
                    units: 1,
                    useBias: false,
                    activattion: 'linear',
                    inputDim: 1,
                }))

                const optimizer = tf.train.sgd(0.1)

                model.compile({
                    loss: "meanSquaredError",
                    optimizer
                })

                return model;
            }

            async function trainModel(model, trainingFeatureTensor, trainingLabelTensor){

                const { onBatchEnd, onEpochEnd } = tfvis.show.fitCallbacks(
                    { name: "Training Performance" },
                    [ 'loss' ] 
                )
                return model.fit(trainingFeatureTensor, trainingLabelTensor, {
                    batchSize: 512,
                    epochs: 20,
                    validationSplit: 0.2,
                    callbacks: {
                        onBatchEnd, onEpochEnd
                        // onEpochEnd: (epoch, log) => console.log(`Epoch: ${epoch}: loss = ${log.loss}`)
                    }
                });

            }

            async function run () {
            const houseSalesDataset = tf.data.csv("http://127.0.0.1:8080/kc_house_data.csv");
            const sampleDataset = houseSalesDataset.take(10);
            const dataArray = sampleDataset.toArray();
            console.log(dataArray)
            

            const pointDataset = houseSalesDataset.map(record => ({
                x: record.sqft_living,
                y: record.price,
            }));

            const points = await pointDataset.toArray()

            if (points.length % 2 !== 0) {
                points.pop()
            }

            tf.util.shuffle(points)
            plot(points, "Square feet");

            const featureValues = points.map(p => p.x)
            const featureTensor = tf.tensor2d(featureValues, [featureValues.length, 1])

            const labelValues = points.map(p => p.y)
            const labelTensor = tf.tensor2d(labelValues, [labelValues.length, 1])

            featureTensor.print()
            labelTensor.print()

            const normalisedFeature = normalise(featureTensor)
            const normalisedLabel = normalise(labelTensor)

            normalisedFeature.tensor.print()
            normalisedLabel.tensor.print()

            const [trainingFeatureTensor, testingFeatureTensor] = tf.split(normalisedFeature.tensor, 2)
            const [trainingLabelTensor, testingLabelTensor] = tf.split(normalisedLabel.tensor, 2)

            const model = createModel()
            // model.summary()
            tfvis.show.modelSummary({ name: "Model Summary"}, model);
            const layer = model.getLayer(undefined, 0);
            tfvis.show.layer({name: "Layer 1"}, layer)

            const result = await trainModel(model, trainingFeatureTensor, trainingLabelTensor)
            console.log(result)
            const trainingLoss = result.history.loss.pop()
            console.log(`Training set loss: ${trainingLoss}`)

            const validationLoss = result.history.val_loss.pop()
            console.log(`Validation set loss: ${validationLoss}`)

            const lossTensor = model.evaluate(testingFeatureTensor, testingLabelTensor)
            const loss = await lossTensor.dataSync()
            console.log(`Testing set loss: ${loss}`)

            // trainingFeatureTensor.print(true)

            // denormalise(normalisedFeature.tensor, normalisedFeature.min, normalisedFeature.max).print()

            }

            run()


        </script>
    </body>
</html>